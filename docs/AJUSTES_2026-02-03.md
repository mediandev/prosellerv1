# Ajustes e Funcionalidades - 03/02/2026

## Resumo das Principais Alterações

### 1. Correção do Combobox de Empresas
- **Problema**: Apenas 1 empresa aparecia no combobox, mesmo com 3 empresas retornadas pela API
- **Solução**: 
  - Removido filtro obrigatório de CNPJ no `empresasOptions`
  - Ajustado label para exibir CNPJ apenas quando disponível
  - Corrigida extração de dados da API para lidar com formato `{ success: true, data: [...] }`
- **Arquivos**: `src/components/CustomerFormCondicaoComercial.tsx`, `src/services/api.ts`

### 2. Integração de Produtos Completos na Lista de Preço
- **Funcionalidade**: Exibição de informações completas dos produtos (descrição, SKU, EAN, NCM, CEST, pesos) no diálogo "Adicionar Item ao Pedido"
- **Implementação**:
  - Criada função RPC `get_lista_preco_produtos_completos` para buscar produtos com detalhes completos
  - Atualizada Edge Function `listas-preco-v2` para usar a nova RPC
  - Ajustado mapeamento em `api.ts` para incluir todos os campos do produto
- **Arquivos**: `supabase/migrations/061_rpc_get_lista_preco_produtos_completos.sql`, `supabase/functions/listas-preco-v2/index.ts`, `src/services/api.ts`

### 3. Melhorias no Layout do Diálogo "Adicionar Item ao Pedido"
- **Ajustes Visuais**:
  - Diálogo com `max-w-3xl` e scroll vertical
  - Campos de input com altura padronizada (`h-11`)
  - Seção "Informações do Produto" com header destacado e borda lateral
  - Grid de 2 colunas para valores (tabela, desconto, unitário, subtotal)
  - Mensagens de erro usando componente `Alert` com ícone
- **Arquivos**: `src/components/SaleFormPage.tsx`

### 4. Campo "Lista de Preço" no SaleFormPage
- **Funcionalidade**: Exibição automática do nome da lista de preço quando um cliente é selecionado
- **Implementação**:
  - Busca automática da lista de preço via Edge Function `listas-preco-v2` quando `cliente.listaPrecos` é um ID numérico
  - Fallback para busca local se a API falhar
  - Campo de input exibindo `nomeListaPreco` (somente leitura)
- **Arquivos**: `src/components/SaleFormPage.tsx`, `src/services/api.ts`

### 5. Remoção da Coluna "Contato" na Lista de Clientes
- **Ajuste**: Removida coluna "Contato" da tabela de clientes em `CustomersListPage`
- **Arquivos**: `src/components/CustomersListPage.tsx`

### 6. Correções no Update de Cliente (empresaFaturamento, vendedoresAtribuidos, condicoesPagamentoAssociadas)
- **Problema**: Campos não estavam sendo salvos durante a atualização do cliente
- **Solução**:
  - Adicionados parâmetros `p_empresa_faturamento_id` e `p_condicoes_pagamento_ids` na RPC `update_cliente_v2`
  - Ajustado processamento na Edge Function `clientes-v2` para mapear corretamente os IDs
  - Atualizado `get_cliente_completo_v2` para retornar `empresaFaturamento` e `vendedoresatribuidos` com detalhes completos
  - Corrigido mapeamento em `api.ts` para extrair dados corretamente
- **Migrations**: 
  - `062_add_empresa_faturamento_vendedores_condicoes_to_update_cliente_v2.sql`
  - `063_fix_update_cliente_v2_ambiguous_cliente_id_condicoes.sql`
  - `064_fix_update_cliente_v2_empresa_faturamento_case.sql`
  - `065_fix_update_cliente_v2_condicoes_pagamento_ids_direct_to_cliente.sql`
  - `066_fix_get_cliente_completo_v2_vendedores_empresa_faturamento.sql`

### 7. Exibição de Condições de Pagamento Associadas
- **Funcionalidade**: Tabela em `CustomerFormCondicaoComercial` exibindo condições de pagamento associadas ao cliente
- **Implementação**:
  - Filtro de condições baseado em `condicoesPagamentoAssociadas` (array de IDs)
  - Exibição de nome, forma de pagamento, prazo, desconto e valor mínimo
  - Diálogo para gerenciar condições com checkboxes
  - Integração com Edge Function `condicoes-pagamento-v2` para buscar dados completos
- **Arquivos**: `src/components/CustomerFormCondicaoComercial.tsx`, `src/services/api.ts`

## Arquivos Modificados

### Frontend
- `src/components/CustomerFormCondicaoComercial.tsx`
- `src/components/SaleFormPage.tsx`
- `src/components/CustomersListPage.tsx`
- `src/services/api.ts`

### Backend (Migrations)
- `supabase/migrations/061_rpc_get_lista_preco_produtos_completos.sql`
- `supabase/migrations/062_add_empresa_faturamento_vendedores_condicoes_to_update_cliente_v2.sql`
- `supabase/migrations/063_fix_update_cliente_v2_ambiguous_cliente_id_condicoes.sql`
- `supabase/migrations/064_fix_update_cliente_v2_empresa_faturamento_case.sql`
- `supabase/migrations/065_fix_update_cliente_v2_condicoes_pagamento_ids_direct_to_cliente.sql`
- `supabase/migrations/066_fix_get_cliente_completo_v2_vendedores_empresa_faturamento.sql`

### Edge Functions
- `supabase/functions/listas-preco-v2/index.ts`

## Observações Técnicas

- Todas as correções seguem o padrão arquitetural definido em `edge-function-crud-guide.md`
- RLS policies mantidas e ajustadas conforme necessário
- Validações de dados implementadas tanto no frontend quanto no backend
- Logs de debug adicionados para facilitar troubleshooting futuro
