{"project_id":"xxoiqfraeolsqsmsheue","name":"empresas-v2","entrypoint_path":"index.ts","verify_jwt":true,"files":[{"name":"index.ts","content":"import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'\r\nimport { createClient } from 'https://esm.sh/@supabase/supabase-js@2'\r\n\r\nconst corsHeaders: Record<string, string> = {\r\n  'Access-Control-Allow-Origin': '*',\r\n  'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',\r\n  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',\r\n  'Access-Control-Max-Age': '86400',\r\n}\r\n\r\ninterface AuthenticatedUser {\r\n  id: string\r\n  email: string\r\n  tipo: 'backoffice' | 'vendedor'\r\n  ativo: boolean\r\n}\r\n\r\nasync function validateJWT(\r\n  req: Request,\r\n  supabaseUrl: string,\r\n  supabaseServiceKey: string\r\n): Promise<{ user: AuthenticatedUser | null; error: string | null }> {\r\n  try {\r\n    const authHeader = req.headers.get('Authorization')\r\n    if (!authHeader) return { user: null, error: 'Missing authorization header' }\r\n    const token = authHeader.replace('Bearer ', '')\r\n    const supabase = createClient(supabaseUrl, supabaseServiceKey, {\r\n      global: { headers: { Authorization: authHeader } },\r\n    })\r\n    const { data: { user: authUser }, error: authError } = await supabase.auth.getUser(token)\r\n    if (authError || !authUser) return { user: null, error: 'Invalid or expired token' }\r\n    const { data: userData, error: userError } = await supabase\r\n      .from('user')\r\n      .select('user_id, email, tipo, ativo')\r\n      .eq('user_id', authUser.id)\r\n      .eq('ativo', true)\r\n      .is('deleted_at', null)\r\n      .single()\r\n    if (userError || !userData) return { user: null, error: 'User not found or inactive' }\r\n    return {\r\n      user: {\r\n        id: userData.user_id,\r\n        email: userData.email || authUser.email || '',\r\n        tipo: userData.tipo as 'backoffice' | 'vendedor',\r\n        ativo: userData.ativo,\r\n      },\r\n      error: null\r\n    }\r\n  } catch (error) {\r\n    return { user: null, error: 'Authentication error' }\r\n  }\r\n}\r\n\r\nfunction createAuthErrorResponse(message: string, statusCode: number = 401): Response {\r\n  return new Response(\r\n    JSON.stringify({ error: message, timestamp: new Date().toISOString() }),\r\n    { status: statusCode, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\r\n  )\r\n}\r\n\r\nfunction createHttpSuccessResponse<T>(data: T, status: number = 200, meta?: Record<string, any>): Response {\r\n  return new Response(\r\n    JSON.stringify({ success: true, data, meta: { timestamp: new Date().toISOString(), ...meta } }),\r\n    { status, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\r\n  )\r\n}\r\n\r\nfunction formatErrorResponse(error: Error | unknown): Response {\r\n  let statusCode = 500\r\n  let errorMessage = 'Internal server error'\r\n  if (error instanceof Error) {\r\n    errorMessage = error.message\r\n    if (error.message.includes('Unauthorized') || error.message.includes('authentication')) statusCode = 401\r\n    else if (error.message.includes('permission') || error.message.includes('forbidden')) statusCode = 403\r\n    else if (error.message.includes('not found')) statusCode = 404\r\n    else if (error.message.includes('validation') || error.message.includes('invalid')) statusCode = 400\r\n  }\r\n  console.error('[ERROR]', { message: errorMessage, statusCode })\r\n  return new Response(\r\n    JSON.stringify({ success: false, error: errorMessage, timestamp: new Date().toISOString() }),\r\n    { status: statusCode, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\r\n  )\r\n}\r\n\r\nfunction formatEmpresa(row: any) {\r\n  const endereco = row.endereco && typeof row.endereco === 'object' ? row.endereco : {}\r\n  const contasBancarias = Array.isArray(row.contas_bancarias) ? row.contas_bancarias : (row.contasBancarias || [])\r\n  const integracoesERP = Array.isArray(row.integracoes_erp) ? row.integracoes_erp : (row.integracoesERP || [])\r\n  const chaveApi = row.chave_api ?? row.chaveApi ?? ''\r\n  return {\r\n    id: String(row.id),\r\n    cnpj: row.cnpj ?? '',\r\n    razaoSocial: row.razao_social ?? row.razaoSocial ?? '',\r\n    nomeFantasia: row.nome_fantasia ?? row.nomeFantasia ?? '',\r\n    inscricaoEstadual: row.inscricao_estadual ?? row.inscricaoEstadual ?? '',\r\n    chaveApi,\r\n    endereco: {\r\n      cep: endereco.cep ?? '',\r\n      logradouro: endereco.logradouro ?? '',\r\n      numero: endereco.numero ?? '',\r\n      complemento: endereco.complemento ?? '',\r\n      bairro: endereco.bairro ?? '',\r\n      uf: endereco.uf ?? '',\r\n      municipio: endereco.municipio ?? '',\r\n    },\r\n    contasBancarias,\r\n    integracoesERP,\r\n    ativo: row.ativo ?? true,\r\n    dataCadastro: row.created_at ? new Date(row.created_at).toISOString().slice(0, 10) : new Date().toISOString().slice(0, 10),\r\n  }\r\n}\r\n\r\nserve(async (req) => {\r\n  console.log('[EMPRESAS-V2] Request received:', { method: req.method, url: req.url })\r\n\r\n  // CORS preflight: retornar 204 com headers CORS (evita erro de CORS no browser)\r\n  if (req.method === 'OPTIONS') {\r\n    return new Response(null, {\r\n      status: 204,\r\n      headers: corsHeaders,\r\n    })\r\n  }\r\n\r\n  try {\r\n    const supabaseUrl = Deno.env.get('SUPABASE_URL')!\r\n    const supabaseServiceKey = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!\r\n\r\n    const { user, error: authError } = await validateJWT(req, supabaseUrl, supabaseServiceKey)\r\n    if (authError || !user) {\r\n      return createAuthErrorResponse(authError || 'Unauthorized')\r\n    }\r\n\r\n    const supabase = createClient(supabaseUrl, supabaseServiceKey, {\r\n      global: { headers: { Authorization: req.headers.get('Authorization') || '' } },\r\n    })\r\n\r\n    const url = new URL(req.url)\r\n    const pathParts = url.pathname.split('/').filter(p => p)\r\n    const functionIndex = pathParts.indexOf('empresas-v2')\r\n    const empresaIdParam = functionIndex >= 0 && functionIndex < pathParts.length - 1\r\n      ? pathParts[functionIndex + 1]\r\n      : url.searchParams.get('id')\r\n    const empresaIdBigint = empresaIdParam ? parseInt(empresaIdParam, 10) : NaN\r\n\r\n    if (req.method === 'GET') {\r\n      if (empresaIdParam && !isNaN(empresaIdBigint)) {\r\n        const { data: rows, error: rpcError } = await supabase\r\n          .rpc('get_empresas_v2', { p_id: empresaIdBigint })\r\n        if (rpcError) throw new Error(`Database operation failed: ${rpcError.message}`)\r\n        if (!rows || rows.length === 0) throw new Error('Empresa não encontrada')\r\n        const formatted = formatEmpresa(rows[0])\r\n        return createHttpSuccessResponse(formatted, 200, { userId: user.id })\r\n      }\r\n\r\n      const search = url.searchParams.get('search') || null\r\n      const apenasAtivos = url.searchParams.get('apenas_ativos') === 'true'\r\n      const page = parseInt(url.searchParams.get('page') || '1')\r\n      const limit = Math.min(parseInt(url.searchParams.get('limit') || '100'), 100)\r\n\r\n      const { data: rpcData, error: rpcError } = await supabase\r\n        .rpc('list_empresas_v2', {\r\n          p_requesting_user_id: user.id,\r\n          p_search: search,\r\n          p_apenas_ativos: apenasAtivos,\r\n          p_page: page,\r\n          p_limit: limit,\r\n        })\r\n      if (rpcError) throw new Error(`Database operation failed: ${rpcError.message}`)\r\n\r\n      const empresas = rpcData?.empresas || []\r\n      const formattedList = empresas.map((e: any) => {\r\n        const chaveApi = e.chave_api ?? e.chaveApi ?? ''\r\n        return {\r\n          id: String(e.id),\r\n          cnpj: e.cnpj ?? '',\r\n          razaoSocial: e.razaoSocial ?? e.razao_social ?? '',\r\n          nomeFantasia: e.nomeFantasia ?? e.nome_fantasia ?? '',\r\n          inscricaoEstadual: e.inscricaoEstadual ?? e.inscricao_estadual ?? '',\r\n          chaveApi,\r\n          endereco: e.endereco && typeof e.endereco === 'object' ? e.endereco : { cep: '', logradouro: '', numero: '', complemento: '', bairro: '', uf: '', municipio: '' },\r\n        contasBancarias: Array.isArray(e.contasBancarias) ? e.contasBancarias : [],\r\n        integracoesERP: Array.isArray(e.integracoesERP) ? e.integracoesERP : [],\r\n        ativo: e.ativo ?? true,\r\n        dataCadastro: e.createdAt ? new Date(e.createdAt).toISOString().slice(0, 10) : '',\r\n        }\r\n      })\r\n      return createHttpSuccessResponse(formattedList, 200, { userId: user.id })\r\n    }\r\n\r\n    if (req.method === 'POST') {\r\n      const body = await req.json()\r\n      if (user.tipo !== 'backoffice') {\r\n        throw new Error('Apenas usuários backoffice podem criar empresas')\r\n      }\r\n      if (!body.cnpj || !String(body.cnpj).trim()) {\r\n        throw new Error('CNPJ é obrigatório')\r\n      }\r\n      if (!body.razaoSocial || String(body.razaoSocial).trim().length < 2) {\r\n        throw new Error('Razão social deve ter pelo menos 2 caracteres')\r\n      }\r\n\r\n      const { data: rows, error: rpcError } = await supabase\r\n        .rpc('create_empresas_v2', {\r\n          p_cnpj: String(body.cnpj).trim(),\r\n          p_razao_social: String(body.razaoSocial).trim(),\r\n          p_nome_fantasia: body.nomeFantasia ? String(body.nomeFantasia).trim() : null,\r\n          p_inscricao_estadual: body.inscricaoEstadual ? String(body.inscricaoEstadual).trim() : null,\r\n          p_endereco: body.endereco && typeof body.endereco === 'object' ? body.endereco : {},\r\n          p_contas_bancarias: Array.isArray(body.contasBancarias) ? body.contasBancarias : [],\r\n          p_integracoes_erp: Array.isArray(body.integracoesERP) ? body.integracoesERP : [],\r\n          p_created_by: user.id,\r\n        })\r\n      if (rpcError) throw new Error(`Database operation failed: ${rpcError.message}`)\r\n      if (!rows || rows.length === 0) throw new Error('Erro ao criar empresa')\r\n\r\n      const formatted = formatEmpresa(rows[0])\r\n      return createHttpSuccessResponse(formatted, 201, { userId: user.id })\r\n    }\r\n\r\n    if (req.method === 'PUT') {\r\n      const body = await req.json()\r\n      const idParam = empresaIdParam || body.id\r\n      if (idParam == null || idParam === '') throw new Error('ID é obrigatório para atualização')\r\n      const idBigint = typeof idParam === 'number' ? idParam : parseInt(String(idParam), 10)\r\n      if (isNaN(idBigint)) throw new Error('ID inválido')\r\n      if (user.tipo !== 'backoffice') {\r\n        throw new Error('Apenas usuários backoffice podem atualizar empresas')\r\n      }\r\n\r\n      const { data: rows, error: rpcError } = await supabase\r\n        .rpc('update_empresas_v2', {\r\n          p_id: idBigint,\r\n          p_cnpj: body.cnpj !== undefined ? String(body.cnpj).trim() : null,\r\n          p_razao_social: body.razaoSocial !== undefined ? String(body.razaoSocial).trim() : null,\r\n          p_nome_fantasia: body.nomeFantasia !== undefined ? (body.nomeFantasia ? String(body.nomeFantasia).trim() : null) : null,\r\n          p_inscricao_estadual: body.inscricaoEstadual !== undefined ? (body.inscricaoEstadual ? String(body.inscricaoEstadual).trim() : null) : null,\r\n          p_endereco: body.endereco !== undefined ? (body.endereco && typeof body.endereco === 'object' ? body.endereco : null) : null,\r\n          p_contas_bancarias: body.contasBancarias !== undefined ? (Array.isArray(body.contasBancarias) ? body.contasBancarias : null) : null,\r\n          p_integracoes_erp: body.integracoesERP !== undefined ? (Array.isArray(body.integracoesERP) ? body.integracoesERP : null) : null,\r\n          p_ativo: body.ativo !== undefined ? body.ativo : null,\r\n          p_updated_by: user.id,\r\n        })\r\n      if (rpcError) throw new Error(`Database operation failed: ${rpcError.message}`)\r\n      if (!rows || rows.length === 0) throw new Error('Empresa não encontrada')\r\n\r\n      const formatted = formatEmpresa(rows[0])\r\n      return createHttpSuccessResponse(formatted, 200, { userId: user.id })\r\n    }\r\n\r\n    if (req.method === 'DELETE') {\r\n      const idParam = empresaIdParam || url.searchParams.get('id')\r\n      if (idParam == null || idParam === '') throw new Error('ID é obrigatório para exclusão')\r\n      const idBigint = parseInt(String(idParam), 10)\r\n      if (isNaN(idBigint)) throw new Error('ID inválido')\r\n      if (user.tipo !== 'backoffice') {\r\n        throw new Error('Apenas usuários backoffice podem excluir empresas')\r\n      }\r\n\r\n      const { error: deleteError } = await supabase\r\n        .rpc('delete_empresas_v2', { p_id: idBigint, p_deleted_by: user.id })\r\n      if (deleteError) throw new Error(`Database operation failed: ${deleteError.message}`)\r\n\r\n      return createHttpSuccessResponse(\r\n        { success: true, message: 'Empresa excluída com sucesso' },\r\n        200,\r\n        { userId: user.id }\r\n      )\r\n    }\r\n\r\n    return new Response(\r\n      JSON.stringify({ success: false, error: 'Method not allowed', timestamp: new Date().toISOString() }),\r\n      { status: 405, headers: { ...corsHeaders, 'Content-Type': 'application/json' } }\r\n    )\r\n  } catch (error) {\r\n    console.error('[EMPRESAS-V2] EXCEPTION:', error instanceof Error ? error.message : String(error))\r\n    return formatErrorResponse(error)\r\n  }\r\n})\r\n"}]}